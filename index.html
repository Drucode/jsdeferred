<!DOCTYPE html>
<html>
	<head>
		<title>JSDeferred - Asynchronous library in JavaScript. Standalone and Compact</title>
		<meta charset="utf-8"/>

		<link href='http://fonts.googleapis.com/css?family=Buenard' rel='stylesheet' type='text/css'/>
		<link rel="stylesheet/tass" type="text/x-tass" href="styles.tass"/>
		<script type="text/javascript" src="http://cdn.washer-in-the-rye.com/tass.js"></script>
		<script type="text/javascript" src="http://code.jquery.com/jquery-1.7.1.min.js"></script>
		<script type="text/javascript" src="http://cdn.washer-in-the-rye.com/jsdeferred.js"></script>
		<script type="text/javascript" src="http://cdn.washer-in-the-rye.com/jsdeferred.jquery.js"></script>
		<script type="text/javascript" src="scripts.js"></script>

		<!--[if lt IE 9]>
		<script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
		<![endif]-->
	</head>
	<body>
		<div id="whole">
			<header id="top">
				<h1><a href="/">JSDeferred</a></h1>
				<p class="description">Standalone and Compact asynchronous library in JavaScript.</p>
			</header>

			<nav id="global-navigation">
				<ul>
					<li><a href="./#overview">Overview</a></li>
					<li><a href="./#download">Download</a></li>
					<li><a href="./#tutorial">Tutorial</a></li>
					<li><a href="./#cookbook">Cookbook</a></li>
					<li><a href="./doc/Deferred.html">API</a></li>
					<li><a href="./#development">Development</a></li>
				</ul>
			</nav>

			<div id="content">
				<div id="content-inner">
					<div id="overview" class="line">
						<section class="grid-6">
							<h1>Overview</h1>
							<p>
								JSDeferred is standalone and compact asynchronous library.
								Asynchronous codes are very confused because it is a storm of callbacks.
								JSDeferred improve the readability of asynchronous codes by providing one object and some functions.
							</p>

							<pre>
next(<span class="Identifier">function</span> () {
    alert(<span class="Constant">'Hello,'</span>);
    <span class="Statement">return</span> wait(<span class="Constant">3</span>);
}).
next(<span class="Identifier">function</span> (r) {
    alert(<span class="Constant">'World!'</span>);
});
</pre>

							<p>"Standalone and Compact" means JSDeferred is very portable so works in many environment.</p>
						</section>

						<section class="grid-6" id="download">
							<h1>Download</h1>
							<ul class="line">
								<li class="grid-2">
									<a href="https://github.com/cho45/jsdeferred/blob/master/jsdeferred.jquery.js">
										<h1>With jQuery</h1>
										<p>For web use and jQuery users.</p>
									</a>
								</li>
								<li class="grid-2">
									<a href="https://raw.github.com/cho45/jsdeferred/master/jsdeferred.nodoc.js">
										<h1>Plain Edition</h1>
										<p>For generic use. Web without jQuery or etc...</p>
									</a>
								</li>
								<li class="grid-2">
								<a href="https://raw.github.com/cho45/jsdeferred/master/jsdeferred.userscript.js">
										<h1>For userscripts</h1>
										<p>For use <code>with(D()) { ... }</code></p>
									</a>
								</li>
								<li class="grid-2">
									<a href="https://raw.github.com/cho45/jsdeferred/master/jsdeferred.jetpack.js">
										<h1>For Add-on SDK</h1>
										<p>Provides some utilities.</p>
									</a>
								</li>
								<li class="grid-2">
									<a href="https://raw.github.com/cho45/jsdeferred/master/jsdeferred.js">
										<h1>Documented</h1>
										<p>Full documented version.</p>
									</a>
								</li>
								<li class="grid-2">
									<a href="https://github.com/cho45/jsdeferred/binding">
										<h1>Others</h1>
										<p>Other resources.</p>
									</a>
								</li>
							</ul>
						</section>

						<section class="grid-12" id="supported">
							<h1>Supported Environment</h1>
							<ul class="line">
								<li class="grid-2">
									<h1>Browsers</h1>
									<p>
										Offcourse, almost browsers are supported:
										<a href="http://www.google.com/chrome/">Google Chrome</a>,
										<a href="http://www.mozilla.org/en-US/firefox/new/">Mozilla Firefox</a>,
										<a href="http://www.opera.com/">Opera,</a>
										<a href="http://windows.microsoft.com/en-us/internet-explorer/products/ie/home">Microsoft Internet Explorer</a> and etc.
									</p>
								</li>
								<li class="grid-2">
									<h1><a href="http://nodejs.org/">node.js</a></h1>
									<p>
										node.js provides many many asynchronous functions. JSDeferred helps program readability.
									</p>
								</li>
								<li class="grid-2">
									<h1><a href="http://code.google.com/chrome/extensions/index.html">Chrome Extension</a></h1>
									<p>
										Google Chrome provides HTML5 based extension feature. JSDeferred can be used with it.
									</p>
								</li>
								<li class="grid-2">
									<h1><a href="https://addons.mozilla.org/ja/developers/builder">Firefox Add-on SDK</a></h1>
									<p>
										JSDeferred can work in Firefox Add-on SDK (also known as Jetpack SDK) environment completely.
									</p>
								</li>
								<li class="grid-2">
									<h1><a href="http://www.appcelerator.com/products/titanium-mobile-application-development/">Titanium</a></h1>
									<p>
										Titanium Mobile SDK can create iPhone and Android application by JavaScript. JSDeferred can works it.
									</p>
								</li>
								<li class="grid-2">
									<h1><a href="http://www.greasespot.net/">Greasemonkey</a></h1>
									<p>
										JSDeferred is standalone and compact. So you can just copy and paste your userscripts.
									</p>
								</li>
							</ul>
							<p>In fact, JSDeferred only depends on setTimeout() function, so if setTimeout is provided, JSDeferred will work.</p>
						</section>
					</div>

					<div class="line">
						<section class="grid-12" id="tutorial">
							<h1>Tutorial</h1>

							<section>
								<h1>Loading</h1>

								<p>To use JSDeferred, add a script element to the HTML</p>
								<pre>
<span class="Identifier">&lt;</span><span class="Identifier">script</span><span class="Identifier"> </span><span class="Type">type</span>=<span class="Constant">&quot;text/javascript&quot;</span><span class="Identifier"> </span><span class="Type">src</span>=<span class="Constant">&quot;jsdeferred.js&quot;</span><span class="Identifier">&gt;</span><span class="Identifier">&lt;/script&gt;</span>
<span class="Identifier">&lt;</span><span class="Identifier">script</span><span class="Identifier"> </span><span class="Type">type</span>=<span class="Constant">&quot;text/javascript&quot;</span><span class="Identifier"> </span><span class="Type">src</span>=<span class="Constant">&quot;my.js&quot;</span><span class="Identifier">&gt;</span><span class="Identifier">&lt;/script&gt;</span>
</pre>
								<p>JSDeferred is stand-alone, and does not depend on any external libraries, so that loading jsdeferred.js is sufficient in order to use it. The codes below are what would be written in my.js.</p>

								<h2>The First Step</h2>
								<p>Loading JSDeferred defines the Deferred object.
								For convenience, we export a set of functions to the global scope by Deferred.define(). You don't, of course, need to export those functions at all.</p>
								<pre>
Deferred.define();
</pre>
								<p>By doing this, you can use useful functions such as next(), loop(), call(), parallel() and wait() as global functions.
								Let's write some asynchronous process. </p>
								<pre>
next(<span class="Identifier">function</span> () {
    alert(<span class="Constant">&quot;Hello!&quot;</span>);
    <span class="Statement">return</span> wait(<span class="Constant">5</span>);
}).
next(<span class="Identifier">function</span> () {
    alert(<span class="Constant">&quot;World!&quot;</span>);
});
</pre>
								<p>This is a process that alerts <sample>Hello!</sample>, then alerts <sample>World!</sample> after 5 seconds of delay.</p>
								<p>The above code is exactly the same as the following. It can be used even if you don't choose to export the functions using Deferred.define().
								</p>
								<pre>
Deferred.next(<span class="Identifier">function</span> () {
    alert(<span class="Constant">&quot;Hello!&quot;</span>);
    <span class="Statement">return</span> Deferred.wait(<span class="Constant">5</span>);
}).
next(<span class="Identifier">function</span> () {
    alert(<span class="Constant">&quot;World!&quot;</span>);
});
</pre>

							</section>
							<section>
								<h1>Comparison with ordinary callback processes</h1>
								<p>What's the advantage of writing in such style.</p>
								<p>If you give a function as a callback, then asynchronous processes are written as a nest of functions. For example, if you want to fetch /foo.json, /bar.json, /baz.json in this order.</p>
								<pre>
<span class="Comment">// http.get is assumed to be a function that takes a URI and a callback function as arguments</span>
http.get(<span class="Constant">&quot;/foo.json&quot;</span>, <span class="Identifier">function</span> (dataOfFoo) {
    http.get(<span class="Constant">&quot;/bar.json&quot;</span>, <span class="Identifier">function</span> (dataOfBar) {
        http.get(<span class="Constant">&quot;/baz.json&quot;</span>, <span class="Identifier">function</span> (dataOfBaz) {
            alert([dataOfFoo, dataOfBar, dataOfBaz]);
        });
    });
});
</pre>
								<p>You see here that the nesting of functions get deeper and deeper as you have more asynchronous processes. What if you want get an arbitrary number of data?</p>
								<pre>
<span class="Type">var</span> wants = [<span class="Constant">&quot;/foo.json&quot;</span>, <span class="Constant">&quot;/bar.json&quot;</span>, <span class="Constant">&quot;/baz.json&quot;</span>];
<span class="Comment">// How would you write that?</span>
</pre>
								<p>It's too cumbersome to do it. Let's do it with the Deferred.</p>
								<pre>
<span class="Comment">// http.get is assumed to be a function that takes a URI as an argument and returns a Deferred instance</span>
<span class="Type">var</span> results = [];
next(<span class="Identifier">function</span> () {
    <span class="Statement">return</span> http.get(<span class="Constant">&quot;/foo.json&quot;</span>).next(<span class="Identifier">function</span> (data) {
        results.push(data);
    });
}).
next(<span class="Identifier">function</span> () {
    <span class="Statement">return</span> http.get(<span class="Constant">&quot;/baz.json&quot;</span>).next(<span class="Identifier">function</span> (data) {
        results.push(data);
    });
}).
next(<span class="Identifier">function</span> () {
    <span class="Statement">return</span> http.get(<span class="Constant">&quot;/baz.json&quot;</span>).next(<span class="Identifier">function</span> (data) {
        results.push(data);
    });
}).
next(<span class="Identifier">function</span> () {
    alert(results);
});
</pre>
								<p>The code is longer, but the processes are in serial. I can even combine the part occurring three times.</p>
								<pre>
<span class="Type">var</span> wants = [<span class="Constant">&quot;/foo.json&quot;</span>, <span class="Constant">&quot;/bar.json&quot;</span>, <span class="Constant">&quot;/baz.json&quot;</span>];
<span class="Type">var</span> results = [];
loop(wants.length, <span class="Identifier">function</span> (i) {
    <span class="Statement">return</span> http.get(wants[i]).next(<span class="Identifier">function</span> (data) {
        results.push(data);
    });
}).
next(<span class="Identifier">function</span> () {
    alert(results);
});
</pre>
								<p>Now it's shorter, and can handle any number of requests. "loop" is a function that, if a Deferred instance is returned in the argument function, 
								it waits until the deferred process to finish and then execute the following process.</p>
								<p>The above is a code to fire requests sequentially, i.e. load foo.json then bar.json and so on,
								you probably have more situations where you want to load them all at once. In that case, you can simply write as this.</p>
								<pre>
parallel([
    http.get(<span class="Constant">&quot;/foo.json&quot;</span>),
    http.get(<span class="Constant">&quot;/bar.json&quot;</span>),
    http.get(<span class="Constant">&quot;/baz.json&quot;</span>)
]).
next(<span class="Identifier">function</span> (results) {
    alert(results);
});
</pre>
								<p>"parallel" is a function that executes the following process after all Deferred instances have finished their processes. It's that simple, isn't it?</p>
							</section>
							<section>
								<h1>Error Handling</h1>
								<p>What's useful about Deferred is its error handling. Browsers like Firefox kills errors occurred during an asynchronous process without raising the error console.
								How would you debug such a case?</p>
								<p>I normally surround the asynchronous process with a "try {} catch (e) { alert(e) }", but it's tedious to do it every time.</p>
								<p>JSDeferred can create an error-back flow apart from its normal callback flow. For example, have a code like this.</p>
								<pre>
next(<span class="Identifier">function</span> () {
<span class="Comment">    // something 1</span>
}).
next(<span class="Identifier">function</span> () {
<span class="Comment">    // asynchronous process</span>
    <span class="Statement">throw</span> <span class="Constant">&quot;error!&quot;</span>;
}).
next(<span class="Identifier">function</span> () {
<span class="Comment">    // something 2 (not executed as an error occurs in the previous process)</span>
});
</pre>
								<p>Now you want to handle exceptions.</p>
								<pre>
next(<span class="Identifier">function</span> () {
<span class="Comment">    // something 1</span>
}).
next(<span class="Identifier">function</span> () {
<span class="Comment">    // asynchronous process</span>
    <span class="Statement">throw</span> <span class="Constant">&quot;error!&quot;</span>;
}).
next(<span class="Identifier">function</span> () {
<span class="Comment">    // something 2 (not executed as an error occurs in the previous process)</span>
}).
error(<span class="Identifier">function</span> (e) {
    alert(e);
});
</pre>
								<p>You just need add .error(). It can catch all the exceptions that occur before the .error() part.</p>
								<p>In the above code the "something 2" won't be executed because of the exception, but if you want to execute it no matter if you get an error, then write like this.</p>
								<pre>
next(<span class="Identifier">function</span> () {
<span class="Comment">    // something 1</span>
}).
next(<span class="Identifier">function</span> () {
<span class="Comment">    // asynchronous process</span>
    <span class="Statement">throw</span> <span class="Constant">&quot;error!&quot;</span>;
}).
error(<span class="Identifier">function</span> (e) {
    alert(e);
}).
next(<span class="Identifier">function</span> () {
<span class="Comment">    // something 2 (executed since the exception would already be handled)</span>
}).
error(<span class="Identifier">function</span> (e) {
    alert(e);
});
</pre>
								<p>You can slide an error handling in the middle. The process after the error() is always executed unless you get another exception in the error() process.</p>
							</section>
							<section>
								<h1>Chain</h1>
								<p>If a Deferred instance is returned in a function given to a Deferred process, it waits for the returned Deferred.</p>
								<pre>
next(<span class="Identifier">function</span> () {
    alert(<span class="Constant">&quot;Hello!&quot;</span>);
    <span class="Statement">return</span> wait(<span class="Constant">5</span>);
}).
next(<span class="Identifier">function</span> () {
    alert(<span class="Constant">&quot;World!&quot;</span>);
});
</pre>
								<p>In the code above, wait() is a function to return a Deferred that "waits for 5 seconds". In this case, the following process waits for the returned Deferred to execute. You can return any other function than wait, which returns a Deferred.</p>
								<p>next() also returns a Deferred instance, so you can write as this.</p>
								<pre>
next(<span class="Identifier">function</span> () {
    alert(<span class="Constant">1</span>);
    <span class="Statement">return</span> next(<span class="Identifier">function</span> () {
        alert(<span class="Constant">2</span>);
    }).
    next(<span class="Identifier">function</span> () {
        alert(<span class="Constant">3</span>);
    });
}).
next(<span class="Identifier">function</span> () {
    alert(<span class="Constant">4</span>);
});
</pre>
								<p>This is executed in the numerical order.</p>
							</section>
							<section>
								<h1>"Deferredize" a Function</h1>
								<p>When you use JSDeferred, you will often find it useful to define a custom function return a Deferred, rather than having it take a callback in a normal fashion.
								It's very easy to do it indeed. As an example of XMLHttpRequest, I'm going to define the http.get which we saw a few times above.</p>
								<pre>
http = {}
http.get = <span class="Identifier">function</span> (uri) {
    <span class="Type">var</span> deferred = <span class="Statement">new</span> Deferred();
    <span class="Type">var</span> xhr = <span class="Statement">new</span> XMLHttpRequest();
    xhr.onreadystatechange = <span class="Identifier">function</span> () {
        <span class="Statement">if</span> (xhr.readyState == <span class="Constant">4</span>) {
            <span class="Statement">if</span> (xhr.status == <span class="Constant">200</span>) {
                deferred.call(xhr);
            } <span class="Statement">else</span> {
                deferred.fail(xhr);
            }
        }
    };
    deferred.canceller = <span class="Identifier">function</span> () { xhr.abort() };
    <span class="Statement">return</span> deferred;
}
</pre>
								<p>Create a Deferred instance with "new Deferred()", and call its "call()" method within an asynchronous callback.
								It will execute processes associated to the callback chain of the Deferred.</p>
								<p>Similarly, calling the "fail()" method fires an error. If you want to catch the exception using ".error()", you need to call the "fail()" appropreately.</p>
								<p>I also defined the canceller. It's executed when the cancel() method of the Deferred instance is called.
								Normally you don't use it much, but you can remember that it exists.</p>

								<h2>Coding an Asynchronous Process</h2>
								<p>When you write a code that depends on Deferred, it is convenient if you write all asynchronous processes as functions to return a Deferred instance.
								Even if you don't need any process to follow it, it makes you easy to put it into a Deferred chain.</p>
								<p>If you are writing a general library, it may be good to first write functions to take callback functions, and then create a function to Deferredize them.</p>
							</section>

							<section>
								<h1>Dividing a Heavy Process</h1>
								<aside class="note">
									<h1>"Speeding Up" JavaScript</h1>
									<p>When you say "Speed Up" JavaScript, it is very important to reduce user's stress rather than speeding up of the process.</p>
									<p>No matter how fast the process is, if it blocks the UI thread for a long time it gives a big stress to the user.
									In JavaScript, <strong>shortest blocking time of UI thread</strong> is more important than the overall time of execution.</p>

									<p>JSDeferred makes it easy to divide a heavy process, for example, using loop() and execute it in batches.
									When you create an application that is fast in the sense of total execution time, but blocks browsers' scrolling (UI), being able to fix it quickly is important in web application development.</p>
								</aside>

								<p>Handling DOM a large number of times with JavaScript can be very heavy for some browsers.
								As a result, browser's UI process such as scrolling gets stuck.
								This can be very stressful for the users, so you should avoid such a thing to happen.</p>
								<p>Of course, it is essential to write an efficient code, but the DOM handling could be inevitable.
								In that case, dividing a process and running asynchronously can make the browser UI smooth.</p>
								<p>The loop() function of JSDeferred can give back control to the browser after each loop.</p>
								<pre>
loop(<span class="Constant">1000</span>, <span class="Identifier">function</span> (n) {
<span class="Comment">    // heavy process</span>
});
</pre>
								<p>Imagine writing this without JSDeferred…… I wouldn't dare to do it.</p>

								<h2>Automatically Divide a Long Loop</h2>
								<p>loop() function is effective when each loop is a heavy process. However, when a single loop is not so heavy but the number of iteration is numerous, it's not efficient.
								Here I define a function called aloop()</p>
								<pre>
<span class="Identifier">function</span> aloop (n, f) {
    <span class="Type">var</span> i = <span class="Constant">0</span>, end = {}, ret = <span class="Type">null</span>;
    <span class="Statement">return</span> Deferred.next(<span class="Identifier">function</span> () {
        <span class="Type">var</span> t = (<span class="Statement">new</span> <span class="Special">Date</span>()).getTime();
        <span class="Statement">divide</span>: {
            <span class="Statement">do</span> {
                <span class="Statement">if</span> (i &gt;= n) <span class="Statement">break</span> divide;
                ret = f(i++);
            } <span class="Statement">while</span> ((<span class="Statement">new</span> <span class="Special">Date</span>()).getTime() - t &lt; <span class="Constant">20</span>);
            <span class="Statement">return</span> Deferred.call(arguments.callee);
        }
    });
}
</pre>
								<p>This is a loop that is automatically divided up every 20 msec.
								Unlike the ordinary loop(), it cannot wait even if a Deferred instance is returned in a loop.</p>
							</section>
						</section>

						<section class="grid-12" id="cookbook">
							<h1>Cookbook</h1>

							<section>
								<h1>Basic Chain</h1>
								<pre class="runnable">
next(<span class="Identifier">function</span> () {
    console.log(<span class="Constant">&quot;start&quot;</span>);
}).
next(<span class="Identifier">function</span> () {
    <span class="Identifier">function</span> pow (x, n) {
        <span class="Identifier">function</span> _pow (n, r) {
            console.log([n, r]);
            <span class="Statement">if</span> (n == <span class="Constant">0</span>) <span class="Statement">return</span> r;
            <span class="Statement">return</span> call(_pow, n - <span class="Constant">1</span>, x * r);
        }
        <span class="Statement">return</span> call(_pow, n, <span class="Constant">1</span>);
    }
    <span class="Statement">return</span> call(pow, <span class="Constant">2</span>, <span class="Constant">10</span>);
}).
next(<span class="Identifier">function</span> (r) {
    console.log([r, <span class="Constant">&quot;end&quot;</span>]);
}).
error(<span class="Identifier">function</span> (e) {
    alert(e);
})
</pre>
							</section>

							<section>
								<h1>Basic Loop</h1>
								<pre class="runnable">
loop(10, function (i) {
	console.log(i)
});
</pre>
							</section>

							<section>
								<h1>Deferred Ajax</h1>
								<pre class="runnable">
$.get("sample.html").next(function (data) {
	console.log(data);
});
</pre>
							</section>

							<section>
								<h1>Parallel Deferred</h1>
								<p>DeferredList</p>
								<pre class="runnable">
console.log("start. gathering data.");

parallel([$.get("README.markdown"), $.get("ChangeLog")]).
next(function (values) {
	var lengths = $.map(values, function (i) { return i.length });
	console.log(lengths.join(", "));
});
</pre>
								<pre class="runnable">
console.log("start. gathering data.");

// named parallel deferred
parallel({html: $.get("README.markdown"), js: $.get("ChangeLog")}).
next(function (values) {
	console.log(["html=", values.html.length, " js=", values.js.length].join(""));
});
</pre>
								<pre class="runnable">
console.log("start. wait 3 sec.");

var list = [];
var printAndReturn = function (i) { console.log(i+"msec elapsed"); return i; };
list.push(wait(0).next(printAndReturn));
list.push(wait(1).next(printAndReturn));
list.push(wait(2).next(printAndReturn));
list.push(wait(3).next(printAndReturn));

parallel(list).next(function (values) {
	console.log("Completed. values: "+values.join(", "));
});
</pre>
							</section>

							<section>
								<h1>Workers</h1>
								<pre class="runnable">
var queue   = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10];
var workers = new Array(2);
var work    = function (job) {
	console.log('working... ' + job);
	return wait(Math.random() * 4);
};

for (var i = 0, len = workers.length; i < len; i++) {
	workers[i] = next(function me () {
		var job = queue.shift();
		if (!job) return;

		console.log("start worker: " + job);
		return next(function () { return job }).
		next(work).
		next(me);
	}).
	error(function (e) {
		alert(e);
	});
}

parallel(workers).next(function () {
	console.log('all done!');
});
</pre>
							</section>

							<section>
								<h1>Divided Loop</h1>
								<pre class="runnable">
next(function () {
	var sum = 0;
	return loop({end:100000, step:1000}, function (n, o) {
		console.log(["Processing divided loop:n=", n, ", sum=", sum, " last?=", o.last].join(""));
		for (var i = 0; i < o.step; i++) {
			// console.log(i + n);
			sum += i + n;
		}
		console.log(["sum=", sum].join(""));
		return sum;
	});
}).
next(function (e) {
	console.log("Result:"+e);
	console.log("end");
}).
error(function (e) {
	console.log(e);
});
</pre>
								<pre class="runnable">
loop({begin: 1, end:100, step:10}, function (n, o) {
	console.log(["Processing divided loop:n=", n, " last?=", o.last].join(""));
	for (var i = 0; i < o.step; i++) {
		var j = n + i;
		console.log(j);
	}
});
</pre>
							</section>
							<section>
								<h1>Auto Divided Loop</h1>
								<pre class="runnable">
function aloop (n, f) {
	var i   = 0;
	var end = new Object;
	var ret = null;
	return Deferred.next(function () {
		var t = (new Date()).getTime();
		try {
			do {
				ret = f(i)
				i++;
				if (i >= n) throw end;
			} while ((new Date()).getTime() - t < 50);
			console.log("Devided: " + ((new Date()).getTime() - t) + "msec.");
			return Deferred.call(arguments.callee);
		} catch (e) {
			if (e == end) {
				console.log("End");
				return ret;
			} else {
				throw e;
			}
		}
	});
}

aloop(100, function (n, o) {
	console.log(n);
	for (var i = 0; i < Math.pow(n, 2); i++) {
		for (var j = n; j; j--);
	}
});
</pre>
							</section>

							<section>
								<h1>Pseudo Multi Thread</h1>
								<pre class="runnable">
loop(10, function (n) {
	console.log(n);
	return wait(0.1);
});

loop(10, function (n) {
	console.log(String.fromCharCode(97+n));
	return wait(0.2);
});
</pre>
							</section>

							<section>
								<h1>Shorthand</h1>
								<pre class="runnable">
console.log(0);
loop(10, function (n) {
	console.log(n);
	return n;
}).
wait(1).
loop(10, function (n) {
	var c = String.fromCharCode(97+n);
	console.log(c);
	return c;
}).
next(function (i) {
	console.log("end");
}).
error(function (e) {
	alert(e);
});
</pre>
							</section>

							<section>
								<h1>Delay Loop</h1>
								<pre class="runnable">
loop(5, function (i, o) {
	console.log(i);
	return o.last? i : wait(1);
}).
next(function (e) {
	console.log("end ["+e+"]");
}).
error(function (e) {
	console.log(e);
});
</pre>
								<pre class="runnable">
next(function (i) {
	function delayloop (i) {
		console.log(i++);
		if (i < 5) {
			return wait(1).next(function () {
				return call(delayloop, i);
			});
		}
	}
	return call(delayloop, 0);
}).
next(function (e) {
	console.log("end");
}).
error(function (e) {
	console.log(e);
});
</pre>
							</section>

							<section>
								<h1>Step Run (event handling)</h1>
								<pre class="runnable" id="step-run">
var deferred = Deferred();
$("#step-run").click(function () { deferred.call() });

loop(5, function (i) {
	console.log("running... " + i);
	return deferred;
}).
next(function () {
	console.log("completed");
});
</pre>

							<section>
								<h1>Brainfuck interpreter</h1>
								<pre id="bfi-code">
function bfrun () {
	var mem    = $("&lt;pre/>"), out = $("&lt;pre/>"), button = $("#bfi-run").hide();
	var sinput = $("#bfi-source").hide(), source = sinput.val();
	var shtml  = $("&lt;div class='code'/>");
	var selems = $.map(source.split(/\n/), function (l) {
		var line = $("&lt;div class='line'/>").appendTo(shtml);
		return $.map(l.split(""), function (c) {
			return $("&lt;span/>").append(c).appendTo(line);
		})
	});
	sinput.before(mem).before(out).before(shtml);

	var pi = {
		"+": function (c) {
			if (!c.stack[0]) return c;
			c.memory[c.pointer]++;
			return c;
		},
		"-": function (c) {
			if (!c.stack[0]) return c;
			c.memory[c.pointer]--;
			return c;
		},
		">": function (c) {
			if (!c.stack[0]) return c;
			c.pointer++;
			c.memory[c.pointer] = (c.memory[c.pointer] || 0);
			return c;
		},
		"&lt;": function (c) {
			if (!c.stack[0]) return c;
			c.pointer--;
			c.memory[c.pointer] = (c.memory[c.pointer] || 0);
			return c;
		},
		".": function (c) {
			if (!c.stack[0]) return c;
			c.output.push(String.fromCharCode(c.memory[c.pointer]));
			return c;
		},
		",": function (c) {
			if (!c.stack[0]) return c;
			c.memory[c.pointer] = "t";
			return c;
		},
		"[": function (c) {
			if (c.memory[c.pointer] == 0) {
				c.stack.unshift(false);
			} else {
				c.stack.unshift(c.pos - 1);
			}
			return c;
		},
		"]": function (c) {
			var s = c.stack.shift();
			if (s) c.pos = s;
			return c;
		}
	};

	next(function () {
		return {
			pos     : 0,
			pointer : 0,
			memory  : [0],
			stack   : [true],
			output  : [],
			source  : source
		};
	}).
	next(function (c) {
		if (selems[c.pos]) selems[c.pos].removeClass("em");
		var chr, fun;
		do {
			chr = c.source.charAt(c.pos);
			fun = pi[chr];
			c.pos++;
		} while (chr.match(/[^&lt;>,.\[\]+-]/));
		var m = c.memory.concat();
		m.splice(c.pointer, 1, "*"+(c.memory[c.pointer] || 0));
		mem.text(m.join(", "));
		out.text(c.output.join(""));

		if (typeof fun == "function") {
			c = fun(c);
			if (c.pos &lt; c.source.length) {
				if (selems[c.pos]) selems[c.pos].addClass("em");
				return call(arguments.callee, c);
			} else {
				return c;
			}
		} else {
			return c;
		}
	}).
	next(function (c) {
		var reset = $("&lt;button>Reset&lt;/button>")
		sinput.after(reset);
		reset.click(function () {
			sinput.show();
			button.show();
			mem.remove();
			out.remove();
			shtml.remove();
			reset.remove();
		});
		console.log("end");
	}).
	error(function (e) {
		alert(e);
	});
}

</pre>
								<script type="text/javascript">eval($("#bfi-code").text());</script>
								<textarea id="bfi-source" cols="50" rows="5">
+++++++++[->+++++>++++++++>+++++++++++<<<]>
>.>++.+++++++..+++.<<-.[->-<]>++++.>+++++++
+.--------.+++.------.--------.<+.
</textarea>
								<button id="bfi-run" onclick="bfrun();">Run!</button>
							</section>

							<section>
								<h1>callcc</h1>
								<p>like Scheme's callcc</p>
								<pre class="runnable">
function callcc (fun) {
	var error = new Deferred();
	return call(function () {
		// JSDeferred passes current Deferred Object to  this.
		var ccdeferred = this;
		// Call with current continuation (calling Deferred.next)
		return fun(function (a) { ccdeferred._next.call(a); throw error });
	}).
	error(function (e) {
		// Current Deferred chain must be stopped
		if (e === error) {
			return e;
		} else {
			throw e;
		}
	});
}

callcc(function (cont) {
	return 10 * 10 * cont(20);
}).
next(function (val) {
	console.log("callcc1 returns:" + val);
});
// should show "callcc1 returns:20"

var cont;
var i = 0;
callcc(function (c) {
	cont = c;
	return 10;
}).
next(function (val) {
	console.log("callcc2 returns:" + val);
	if (!i++) cont(20);
});
// should show "callcc2 returns:10", "callcc returns:20"
</pre>

								<p>and Scheme's amb</p>
								<pre class="runnable">
function callcc (fun) {
	var error = new Deferred();
	return call(function () {
		// JSDeferred passes current Deferred Object to  this.
		var ccdeferred = this;
		// Call with current continuation (calling Deferred.next)
		return fun(function (a) { ccdeferred._next.call(a); throw error });
	}).
	error(function (e) {
		// Current Deferred chain must be stopped
		if (e === error) {
			return e;
		} else {
			throw e;
		}
	});
}

// http://www.sampou.org/scheme/t-y-scheme/t-y-scheme-Z-H-16.html#node_chap_14
// Just port above.
function amb () {
	var alts = arguments;
	var prevAmbFail = amb.ambFail;

	return callcc(function (sk) {
		return loop(alts.length, function (i) {
			var alt = alts[i];
			return callcc(function (fk) {
				amb.ambFail = function () {
					amb.ambFail = prevAmbFail;
					return fk("fail");
				};
				return sk(alt);
			});
		}).
		next(prevAmbFail);
	});
}
amb.ambFail = function () { throw "amb tree exhausted" };

// Utility function
function amb1 (ambvars) {
	var f    = wait(0);
	var vars = {};
	for (var k in ambvars) if (ambvars.hasOwnProperty(k)) (function (name, val) {
		console.log(name);
		f = f.next(function () {
			return amb.apply(this, val).next(function (i) {
				vars[name] = i;
				return vars;
			});
		});
	})(k, ambvars[k]);

	return f;
}

function assert (cond) {
	if (!cond) throw amb();
}

// http://mayokara.info/note/view/251
Array.prototype.uniq = function(){
	for (var i = 0,l = this.length; i &lt; l; i++) {
		if (this.indexOf(this[i]) &lt; i) {
			this.splice(i--, l-- &amp;&amp; 1);
		}
	}
	return this;
};

amb1({
	baker    : [1, 2, 3, 4, 5],
	cooper   : [1, 2, 3, 4, 5],
	fletcher : [1, 2, 3, 4, 5],
	miller   : [1, 2, 3, 4, 5],
	smith    : [1, 2, 3, 4, 5]
}).
next(function (vars) { with (vars) {
	console.log(vars);
	// 簡易 distinct
	assert([baker, cooper, fletcher, miller, smith].uniq().length == 5);
	console.log("distinct passed");
	assert(baker  != 5);
	assert(cooper != 1);
	assert(fletcher != 1 &amp;&amp; fletcher != 5);
	assert(miller > cooper);
	assert(Math.abs(smith - fletcher)  != 1);
	assert(Math.abs(fletcher - cooper) != 1);

	return vars;
} }).
next(function (vars) { with (vars) {
	console.log("solved");
	console.log(vars);
	alert(uneval(vars));
} }).
error(function (e) {
	alert(e)
});
</pre>

						</section>
					</div>

					<div id="behavior" class="line">
						<section class="grid-12">
							<h1>Behavior</h1>
							<aside>
								<p>This sections use some words as following meanings.</p>

								<dl>
									<dt>chain</dt>
									<dd>a sequence of processes.</dd>
									<dt>child</dt>
									<dd>the Deferred which returns from a callback.</dd>
									<dt>Deferred#foobar</dt>
									<dd>Deferred.prototype.foobar</dd>
								</dl>
							</aside>

							<section>
								<h1>Deferred structure and chain structure</h1>
								<figure><img src="http://f.hatena.ne.jp/images/fotolife/c/cho45/20071208/20071208021643.png" alt="Deferred structure"/></figure>
								<p>A Deferred object has only one callback as its process. Deferred object packages a process (function) as callback and has reference to next Deferred (this is thought like continuation).</p>

								<p>Example for understanding Deferred structure.</p>

								<pre>
<span class="Type">var</span> d1 = <span class="Statement">new</span> Deferred();
d1.callback.ok = <span class="Identifier">function</span> () {
    alert(<span class="Constant">&quot;1&quot;</span>);
};

<span class="Type">var</span> d2 = <span class="Statement">new</span> Deferred();
d2.callback.ok = <span class="Identifier">function</span> () {
    alert(<span class="Constant">&quot;2&quot;</span>);
};

<span class="Comment">// Set d2 as continuation of d1.</span>
d1._next = d2;

<span class="Comment">// Invoke the chain.</span>
d1.call();
</pre>

								<p>And example for usual use.</p>

								<pre>
next(<span class="Identifier">function</span> () { <span class="Comment">// this `next` is global function</span>
    alert(<span class="Constant">&quot;1&quot;</span>);
}).
next(<span class="Identifier">function</span> () { <span class="Comment">// this `next` is Deferred#next</span>
    alert(<span class="Constant">&quot;2&quot;</span>);
}).
next(<span class="Identifier">function</span> () {
    alert(<span class="Constant">&quot;3&quot;</span>);
});</pre>

								<p>Deferred#next creates new Deferred, sets the passed functions to process of it, sets it as continuation of `this` and returns it.</p>


								<p>This structure makes easy to chain child Deferreds.</p>

								<pre>
next(<span class="Identifier">function</span> () {
    alert(<span class="Constant">&quot;1&quot;</span>);
}).
next(<span class="Identifier">function</span> () {
    alert(<span class="Constant">&quot;2&quot;</span>);
<span class="Comment">    // child Deferred</span>
    <span class="Statement">return</span> next(<span class="Identifier">function</span> () {
        alert(<span class="Constant">&quot;3&quot;</span>);
    });
}).
next(<span class="Identifier">function</span> () {
    alert(<span class="Constant">&quot;4&quot;</span>);
});</pre>

								<figure><img src="http://f.hatena.ne.jp/images/fotolife/c/cho45/20071207/20071207014817.png" alt="Chain child deferred"/></figure>
								<p>When the callback returns Deferred, the Deferred calling the callback only sets its continuation (`_next`) to returned Deferred's continuation.</p>

								
								<pre>
next(<span class="Identifier">function</span> () {
    alert(<span class="Constant">&quot;1&quot;</span>);
}).
next(<span class="Identifier">function</span> () {
    alert(<span class="Constant">&quot;2&quot;</span>);
    <span class="Type">var</span> d = next(<span class="Identifier">function</span> () {
        alert(<span class="Constant">&quot;3&quot;</span>);
    });
    d._next = <span class="Type">this</span>._next;
    <span class="Type">this</span>.cancel();
}).
next(<span class="Identifier">function</span> () {
    alert(<span class="Constant">&quot;4&quot;</span>);
});</pre>

								<p>After the process, above code is same as following:</p>

								
								<pre>
next(<span class="Identifier">function</span> () {
    alert(<span class="Constant">&quot;1&quot;</span>);
}).
next(<span class="Identifier">function</span> () {
    alert(<span class="Constant">&quot;2&quot;</span>);
    next(<span class="Identifier">function</span> () {
        alert(<span class="Constant">&quot;3&quot;</span>);
    }).
    next(<span class="Identifier">function</span> () {
        alert(<span class="Constant">&quot;4&quot;</span>);
    });
});</pre>

							</section>

							<section>
								<h1>Error processing and recovering</h1>
								<p>A Deferred has also error-back for error processing. Let's just see an example (this is from test):</p>

								<pre>
next(<span class="Identifier">function</span> () {
    <span class="Statement">throw</span> <span class="Constant">&quot;Error&quot;</span>;
}).
error(<span class="Identifier">function</span> (e) {
    expect(<span class="Constant">&quot;Errorback called&quot;</span>, <span class="Constant">&quot;Error&quot;</span>, e);
    <span class="Statement">return</span> e; <span class="Comment">// recovering error</span>
}).
next(<span class="Identifier">function</span> (e) {
    expect(<span class="Constant">&quot;Callback called&quot;</span>, <span class="Constant">&quot;Error&quot;</span>, e);
    <span class="Statement">throw</span> <span class="Constant">&quot;Error2&quot;</span>;
}).
next(<span class="Identifier">function</span> (e) {
<span class="Comment">    // This process is not called because</span>
<span class="Comment">    // the error is not recovered.</span>
    ng(<span class="Constant">&quot;Must not be called!!&quot;</span>);
}).
error(<span class="Identifier">function</span> (e) {
    expect(<span class="Constant">&quot;Errorback called&quot;</span>, <span class="Constant">&quot;Error2&quot;</span>, e);
});</pre>

								<p>The error thrown in callback is propagated by error-back chain. If the error-back returns normal value, the error is considered as recovery, and the callback chain continues.</p>
							</section>


							<section>
								<h1>Different-origin Deferred instances</h1>

								<p>JSDeferred can be used in inter-environment which is independent respectively like browser extension
								because JSDeferred determines a self-class identity by instance id.</p>
							</section>

						</section>
					</div>

					<div id="development" class="line">
						<section class="grid-12">
							<h1>Development</h1>

							<div class="line">
								<section id="repository" class="grid-6">
									<h1>Repository</h1>
									<p>JSDeferred is hosted on github.</p>
									<pre>
<span class="Type">$</span> git clone git://github.com/cho45/jsdeferred.git
</pre>
								</section>

								<section id="test" class="grid-6">
									<h1>Test</h1>
									<p><a href="test.html">Browser Tests</a> or CUI tests:</p>
									<pre>
<span class="Type">$</span> node test-node.js
or
<span class="Type">$</span> rhino test-rhino.js
or
<span class="Type">$</span> phantomjs test-phantomjs.js
</pre>
								</section>
							</div>

							<div class="line">
								<section class="grid-6">
									<h1>Active Issues</h1>

									<script src="http://cdn.washer-in-the-rye.com/githubapi.js" data-api="repos/cho45/jsdeferred/issues?sort=updated;state=open;direction=desc">
										<div class="issues">
										<% for (var i = 0, it; (it = data[i]) && i < 5; i++) { %>
											<div class="issue <%= it.state %>">
												<span class="number">#<%= it.number %></span>
												<a href="<%= it.html_url %>" class="title"><%= it.title %></a>
												by
												<span class="author"><img src="<%= it.user.avatar_url %>" width="16" height="16"/><%= it.user.login %></span>
											</div>
										<% } %>
										</div>
									</script>
								</section>
								<section class="grid-6">
									<h1>Closed Issues</h1>
									<script src="http://cdn.washer-in-the-rye.com/githubapi.js" data-api="repos/cho45/jsdeferred/issues?sort=updated;state=closed;direction=desc">
										<div class="issues">
										<% for (var i = 0, it; (it = data[i]) && i < 5; i++) { %>
											<div class="issue <%= it.state %>">
												<span class="number">#<%= it.number %></span>
												<a href="<%= it.html_url %>" class="title"><%= it.title %></a>
												by
												<span class="author"><img src="<%= it.user.avatar_url %>" width="16" height="16"/><%= it.user.login %></span>
											</div>
										<% } %>
										</div>
									</script>
								</section>
							</section>
						</section>
					</div>

					<!-- div id="media" class="line">
						<section class="grid-12">
							<h1>Media</h1>

							<section>
								<figure><a href="http://www.amazon.co.jp/gp/product/4873114977/ref=as_li_ss_il?ie=UTF8&tag=nuso-22&linkCode=as2&camp=247&creative=7399&creativeASIN=4873114977"><img border="0" src="http://ws.assoc-amazon.jp/widgets/q?_encoding=UTF8&Format=_SL160_&ASIN=4873114977&MarketPlace=JP&ID=AsinImage&WS=1&tag=nuso-22&ServiceVersion=20070822" ></a><img src="http://www.assoc-amazon.jp/e/ir?t=nuso-22&l=as2&o=9&a=4873114977" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></figure>
								<p>Firefox Hacks Rebooted: introduce JSDeferred in Add-on SDK by <a href="http://twitter.com/piro_or">@piro_or</a></p>
							</section>

							<section>
								<figure><a href="http://gihyo.jp/dev/feature/01/jsdeferred">特集: JSDeferredで，面倒な非同期処理とサヨナラ</a></figure>
								<p>Japanese tutorial of JSDeferred by @cho45</p>
							</section>
						</section>
					</div -->

					<div id="about" class="line">
						<section class="grid-12">
							<h1>About</h1>
							<section>
								<h1>Contributors</h1>

								<script src="http://cdn.washer-in-the-rye.com/githubapi.js" data-api="repos/cho45/jsdeferred/contributors?">
									<div class="contributors">
									<% for (var i = 0, it; (it = data[i]); i++) { %>
									<a href="http://github.com/<%= it.login %>" class="contributor">
										<img src="<%= it.avatar_url %>" width="24" height="24"/>
										<%= it.login %>
									</a>
									<% } %>
									</div>
								</script>
							</section>
						</section>
					</div>
				</div>
			</div>

			<footer id="global-footer">
				<address>Copyright &copy; <a href="http://www.lowreal.net/">cho45</a> 2007-2012, License under <a href="https://raw.github.com/cho45/jsdeferred/master/jsdeferred.js">MIT</a></address>
			</footer>
		</div>
	</body>
</html>
